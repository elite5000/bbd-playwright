<!-- custom-playwright-report.html -->
<!DOCTYPE html>
<html lang="en" class="theme-light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playwright – Custom Report</title>
    <link rel="stylesheet" href="./style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- === GLOBAL HEADER === -->
    <header style="margin: 1rem; overflow: hidden; display: flex; gap: 1rem;">
        <!-- Pie Chart at top‑right -->
        <canvas id="chart-summary" height="220" style="width: 25%; max-width: 220px; flex-shrink: 0;float: left;"></canvas>

        <div class="info-panel" style="flex: 1; max-width: 75%; float: right;">
            <!-- Counters (All/Passed/Failed/Flaky/Skipped) -->
            <div class="summary-bar" id="counter-bar"></div>

            <!-- Search bar under the counters -->
            <input id="search-box" class="search-input" type="search" placeholder="Search tests…" />

            <!-- Dynamic tag chips -->
            <div id="tag-chips" style="margin-top:.4rem; display:flex; gap:.35rem; flex-wrap:wrap;"></div>
        </div>
    </header>

    <!-- === MAIN LIST OF TESTS === -->
    <main id="tests-container" class="tree" style="padding:0 1rem 2rem 1rem;"></main>

    <!-- === MODAL FOR INDIVIDUAL TEST DETAILS === -->
    <dialog id="test-modal">
        <article style="min-width:70vw;">
            <header style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="modal-title"></h2>
                <button onclick="document.getElementById('test-modal').close()">✕</button>
            </header>
            <section id="steps-container"></section>
            <canvas id="chart-steps" height="160" style="margin-top:1rem;"></canvas>
        </article>
    </dialog>

    <script>
        let REPORT_DATA = { tests: [] };
        fetch('./custom-report-data.json')
            .then(res => res.json())
            .then(data => {
                REPORT_DATA = data;
                initializeReport();
            });



        function renderList() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const activeTags = [...chipBox.querySelectorAll('.chip.selected')].map(x => x.dataset.tag);
            const filterStatus = [...counterBar.querySelectorAll('.chip.selected')].map(x => x.dataset.filter);
            const container = document.getElementById('tests-container');
            container.innerHTML = '';

            const tests = REPORT_DATA.tests.filter(t => {
                if (term && !(t.title + t.describe).toLowerCase().includes(term)) return false;
                if (activeTags.length && !activeTags.includes(t.tag)) return false;
                if (filterStatus.length && !filterStatus.includes('all') && !filterStatus.includes(t.status)) return false;
                return true;
            }).sort((a, b) => a.tag.localeCompare(b.tag) || a.describe.localeCompare(b.describe) || a.title.localeCompare(b.title));

            const grouped = {};
            for (const t of tests) {
                grouped[t.tag] = grouped[t.tag] || {};
                grouped[t.tag][t.describe] = grouped[t.tag][t.describe] || [];
                grouped[t.tag][t.describe].push(t);
            }

            for (const tag in grouped) {
                const tagItem = document.createElement('div');
                tagItem.className = 'tree-item tree-expandable';
                tagItem.innerHTML = `<div class="tree-summary">▸ ${tag}</div>`;

                const describeTree = document.createElement('div');
                describeTree.className = 'tree-children hidden';

                for (const describe in grouped[tag]) {
                    const describeItem = document.createElement('div');
                    describeItem.className = 'tree-item tree-expandable';
                    describeItem.innerHTML = `<div class="tree-summary">▸ ${describe}</div>`;

                    const testTree = document.createElement('div');
                    testTree.className = 'tree-children hidden';

                    grouped[tag][describe].forEach(t => {
                        const testItem = document.createElement('div');
                        testItem.className = 'tree-item tree-leaf';
                        testItem.textContent = `${t.title} – ${t.status}`;
                        testItem.dataset.id = t.id;
                        testTree.appendChild(testItem);
                    });

                    describeItem.appendChild(testTree);
                    describeItem.querySelector('.tree-summary').onclick = () => testTree.classList.toggle('hidden');
                    describeTree.appendChild(describeItem);
                }

                tagItem.appendChild(describeTree);
                tagItem.querySelector('.tree-summary').onclick = () => describeTree.classList.toggle('hidden');
                container.appendChild(tagItem);
            }
        }

        // called after data is loaded
        function initializeReport() {
            const counters = { passed: 0, failed: 0, flaky: 0, skipped: 0 };
            for (const t of REPORT_DATA.tests) counters[t.status]++;
            counters.all = REPORT_DATA.tests.length;
            const counterBar = document.getElementById('counter-bar');
            ['all', 'passed', 'failed', 'flaky', 'skipped'].forEach(key => {
                const btn = document.createElement('button');
                btn.textContent = key.charAt(0).toUpperCase() + key.slice(1) + ' ' + counters[key];
                btn.className = 'chip';
                btn.dataset.filter = key;
                counterBar.appendChild(btn);
            });

            new Chart(document.getElementById('chart-summary').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Passed', 'Failed', 'Flaky', 'Skipped'],
                    datasets: [{
                        data: [counters.passed, counters.failed, counters.flaky, counters.skipped],
                        backgroundColor: ['#4caf50', '#f44336', '#ffc107', '#9e9e9e']
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            const tags = [...new Set(REPORT_DATA.tests.map(t => t.tag))].sort();
            const chipBox = document.getElementById('tag-chips');
            tags.forEach(tag => {
                const div = document.createElement('span');
                div.textContent = tag;
                div.className = 'chip';
                div.dataset.tag = tag;
                chipBox.appendChild(div);
            });

            renderList();
        }

        document.getElementById('search-box').addEventListener('input', renderList);
        chipBox.addEventListener('click', e => { if (e.target.classList.contains('chip')) { e.target.classList.toggle('selected'); renderList(); } });
        counterBar.addEventListener('click', e => { if (e.target.classList.contains('chip')) { e.target.classList.toggle('selected'); renderList(); } });
        document.getElementById('tests-container').addEventListener('click', e => {
            if (e.target.classList.contains('tree-leaf')) {
                const test = REPORT_DATA.tests.find(t => t.id == e.target.dataset.id);
                if (!test) return;
                document.getElementById('modal-title').textContent = test.describe + ' › ' + test.title;
                const stepsContainer = document.getElementById('steps-container'); stepsContainer.innerHTML = '';
                test.steps.forEach(s => { const div = document.createElement('div'); div.textContent = (s.status === 'passed' ? '✔' : '✖') + ' ' + s.name; stepsContainer.appendChild(div); });
                const ctx = document.getElementById('chart-steps').getContext('2d');
                const passedSteps = test.steps.filter(s => s.status === 'passed').length;
                const failedSteps = test.steps.filter(s => s.status === 'failed').length;
                new Chart(ctx, { type: 'pie', data: { labels: ['Passed', 'Failed'], datasets: [{ data: [passedSteps, failedSteps], backgroundColor: ['#4caf50', '#f44336'] }] }, options: { plugins: { legend: { position: 'bottom' } } } });
                document.getElementById('test-modal').showModal();
            }
        });
    </script>
</body>

</html>