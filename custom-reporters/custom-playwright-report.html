<!-- custom-playwright-report.html -->
<!DOCTYPE html>
<html lang="en" class="theme-dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playwright – Custom Report</title>
    <link rel="stylesheet" href="./style.css" />
    <style>
        .summary-bar {
            display: flex;
            gap: .25rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .summary-bar .chip {
            padding: .15rem .6rem;
            border-radius: 4px;
            font-size: .8rem;
            cursor: pointer;
        }

        .chip.selected {
            opacity: .85;
            filter: brightness(1.3);
        }

        #chart-summary {
            width: 25%;
            max-width: 220px;
            max-height:220px;
            flex-shrink: 0;
            float: right;
        }

        #tests-container {
            margin-top: .75rem;
        }

        .tag-group {
            font-weight: 600;
            margin-top: 1.2rem;
        }

        .describe-group {
            margin-left: 1rem;
        }

        .test-item {
            margin-left: 2rem;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        body {
            color: var(--vscode-foreground);
        }

        #search-box {
            width: 60%;
            min-width: 200px;
            max-width: 100%;
        }

        .info-panel {
            float: left;
            min-width: 300px;
            max-width: 75%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- === GLOBAL HEADER === -->
    <header style="margin: 1rem; overflow: hidden;">
        <!-- Pie Chart at top‑right -->
        

        <div class="info-panel">
            <!-- Counters (All/Passed/Failed/Flaky/Skipped) use same markup Playwright does -->
            <div class="summary-bar" id="counter-bar"></div>

            <!-- Search bar under the counters -->
            <input id="search-box" class="search-input" type="search" placeholder="Search tests…"
                style="width:100%; margin-top:.5rem;" />

            <!-- Dynamic tag chips -->
            <div id="tag-chips" style="margin-top:.4rem; display:flex; gap:.35rem; flex-wrap:wrap;"></div>
        </div>
        <canvas id="chart-summary" ></canvas>
    </header>

    <!-- === MAIN LIST OF TESTS === -->
    <main id="tests-container" style="padding:0 1rem 2rem 1rem;"></main>

    <!-- === MODAL FOR INDIVIDUAL TEST DETAILS === -->
    <dialog id="test-modal">
        <article style="min-width:70vw;">
            <header style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="modal-title"></h2>
                <button onclick="document.getElementById('test-modal').close()">✕</button>
            </header>
            <section id="steps-container"></section>
            <canvas id="chart-steps" height="160" style="margin-top:1rem;"></canvas>
        </article>
    </dialog>

    <script>
        const REPORT_DATA = window.__REPORT__ || {
            tests: [
                { id: 1, tag: '@todo', describe: 'New Todo', title: 'should allow me to add', status: 'passed', steps: [{ name: 'fill', status: 'passed' }, { name: 'press', status: 'passed' }] },
                { id: 2, tag: '@todo', describe: 'New Todo', title: 'should clear input', status: 'passed', steps: [{ name: 'fill', status: 'passed' }, { name: 'expect', status: 'passed' }] },
                { id: 3, tag: '@auth', describe: 'Login', title: 'should fail with bad creds', status: 'failed', steps: [{ name: 'goto', status: 'passed' }, { name: 'click', status: 'failed' }] }
            ]
        };

        const counters = { passed: 0, failed: 0, flaky: 0, skipped: 0 };
        for (const t of REPORT_DATA.tests) counters[t.status]++;
        counters.all = REPORT_DATA.tests.length;
        const counterBar = document.getElementById('counter-bar');
        ['all', 'passed', 'failed', 'flaky', 'skipped'].forEach(key => {
            const btn = document.createElement('button'); btn.textContent = key.charAt(0).toUpperCase() + key.slice(1) + ' ' + counters[key];
            btn.className = 'chip'; btn.dataset.filter = key;
            counterBar.appendChild(btn);
        });

        new Chart(document.getElementById('chart-summary').getContext('2d'), {
            type: 'pie',
            data: { labels: ['Passed', 'Failed', 'Flaky', 'Skipped'], datasets: [{ data: [counters.passed, counters.failed, counters.flaky, counters.skipped], backgroundColor: ['#4caf50', '#f44336', '#ffc107', '#9e9e9e'] }] },
            options: { plugins: { legend: { display: false } } }
        });

        const tags = [...new Set(REPORT_DATA.tests.map(t => t.tag))].sort();
        const chipBox = document.getElementById('tag-chips');
        tags.forEach(tag => { const div = document.createElement('span'); div.textContent = tag; div.className = 'chip'; div.dataset.tag = tag; chipBox.appendChild(div); });

        function renderList() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const activeTags = [...chipBox.querySelectorAll('.chip.selected')].map(x => x.dataset.tag);
            const filterStatus = [...counterBar.querySelectorAll('.chip.selected')].map(x => x.dataset.filter);
            const container = document.getElementById('tests-container');
            container.innerHTML = '';
            const tests = [...REPORT_DATA.tests].filter(t => {
                if (term && !(t.title + t.describe).toLowerCase().includes(term)) return false;
                if (activeTags.length && !activeTags.includes(t.tag)) return false;
                if (filterStatus.length && !filterStatus.includes('all') && !filterStatus.includes(t.status)) return false;
                return true;
            }).sort((a, b) => a.tag.localeCompare(b.tag) || a.describe.localeCompare(b.describe) || a.title.localeCompare(b.title));

            let currentTag = ''; let currentDescribe = '';
            for (const t of tests) {
                if (t.tag !== currentTag) { currentTag = t.tag; currentDescribe = ''; const tg = document.createElement('div'); tg.className = 'tag-group'; tg.textContent = currentTag; container.appendChild(tg); }
                if (t.describe !== currentDescribe) { currentDescribe = t.describe; const dg = document.createElement('div'); dg.className = 'describe-group'; dg.textContent = currentDescribe; container.appendChild(dg); }
                const item = document.createElement('div'); item.className = 'test-item'; item.textContent = t.title + ' – ' + t.status; item.dataset.id = t.id; container.appendChild(item);
            }
        }
        renderList();

        document.getElementById('search-box').addEventListener('input', renderList);
        chipBox.addEventListener('click', e => { if (e.target.classList.contains('chip')) { e.target.classList.toggle('selected'); renderList(); } });
        counterBar.addEventListener('click', e => { if (e.target.classList.contains('chip')) { e.target.classList.toggle('selected'); renderList(); } });
        document.getElementById('tests-container').addEventListener('click', e => {
            if (e.target.classList.contains('test-item')) {
                const test = REPORT_DATA.tests.find(t => t.id == e.target.dataset.id);
                if (!test) return;
                document.getElementById('modal-title').textContent = test.describe + ' › ' + test.title;
                const stepsContainer = document.getElementById('steps-container'); stepsContainer.innerHTML = '';
                test.steps.forEach(s => { const div = document.createElement('div'); div.textContent = (s.status === 'passed' ? '✔' : '✖') + ' ' + s.name; stepsContainer.appendChild(div); });
                const ctx = document.getElementById('chart-steps').getContext('2d');
                const passedSteps = test.steps.filter(s => s.status === 'passed').length;
                const failedSteps = test.steps.filter(s => s.status === 'failed').length;
                new Chart(ctx, { type: 'pie', data: { labels: ['Passed', 'Failed'], datasets: [{ data: [passedSteps, failedSteps], backgroundColor: ['#4caf50', '#f44336'] }] }, options: { plugins: { legend: { position: 'bottom' } } } });
                document.getElementById('test-modal').showModal();
            }
        });
    </script>
</body>

</html>